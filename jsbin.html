
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
</head>
<body >
<canvas width="200px" height="200px" id="canvas" style="border:solid 1px #000;"></canvas>
<canvas width="200px" height="200px" id="heatmap" style="border:solid 1px #000;"></canvas>

<h2>RESULTS</h2>
<p id="res"></p>
<div id="data"></div>
<script src="cleaner.js"></script>
<script src="spiral.js"></script>
<script src="snaking.js"></script>
<script>

var c = null;
function addRobot(){
  c = new Spiral(Math.floor(Math.random()*canvas.width),Math.floor(Math.random()*canvas.height),6,"#5f1",Math.random()*Math.PI*2, 3);
}

var canvas = document.getElementById("canvas");
var ctx = canvas.getContext("2d");



addRobot();
var max_runs = 10000;
var run_count = 0;
var current_p = 0;
var steps = 0;
var last_percentage = 0.01;
var percentage = 0;
var data_storage = [[]];
var radians_storage = [[]];
var opacity = [];
opacity.length = parseInt(document.getElementById("canvas").height)*parseInt(document.getElementById("canvas").width);

var refresh_rate = 1;

ctx.fillStyle="#fff";


function addData(data){
  document.getElementById("data").innerHTML += (data + "<br>");
}

function display_data() {
	var data_string = "";
	var turnString = "";
    for(let i = 0; i<95;i++) {
	let sum_d = 0;
	let sum_r = 0;
    	for(let r of data_storage) {
	    if(r.length != 95) {
       	        console.log(data_storage);
                return;
            }
	    sum_d+=r[i];
	}
	for(let r of radians_storage) sum_r+=r[i];

	data_string += (sum_d/max_runs) + "\n";
	turnString += (sum_r/max_runs) + "\n"
    }
	console.log(data_string);
	console.log(turnString);
}




function restart() {
    let imgData=ctx.getImageData(0,0,canvas.width,canvas.height);
    for (var i = 3; i < imgData.data.length; i += 4) {
      if(run_count == 0 ) opacity[parseInt(((i+1)/4)-1)] = imgData.data[i];
      else opacity[parseInt(((i+1)/4)-1)] += imgData.data[i];
    }
    if(run_count == max_runs-1) {
        for(let i in opacity) opacity[i] = opacity[i]/max_runs;
        display_data();
        let c = document.getElementById("heatmap");
        let ct = c.getContext("2d");
        let imgData = ct.getImageData(0,0,c.width,c.height);
        for (var i = 0; i < imgData.data.length; i += 4) {
            let o = Math.round( opacity[((i+3+1)/4)-1] );

            imgData.data[i] = Math.min(o+20,255);
            imgData.data[i+1] = 0;
            imgData.data[i+2] = Math.max(250-o,0);
            imgData.data[i+3] = 200;
        }
         ct.putImageData(imgData,0,0);

    } else {
        addRobot();
        ctx.clearRect(0,0,canvas.width,canvas.height);
        data_storage.push([]);
	    radians_storage.push([]);
        run_count++;
        steps = 0;
        last_percentage = 0.01;
        percentage = 0;
        current_p = 0;
        interval = setInterval(run,refresh_rate);
    }
}

function run(){
  c.move();
  c.render();
  steps++;
  percentage = pixels(ctx);
  if(percentage>last_percentage) {
      data_storage[run_count].push(steps);
      radians_storage[run_count].push(0.5*c.totalAng/Math.PI);
      last_percentage = last_percentage + 0.01;

  }
  if(last_percentage > 0.9501) {
	//console.log(data_storage[run_count].length + "   " +(Math.floor(0.95*100)/100));
      clearInterval(interval);
      restart();
  }

}

function pixels(ctx){
  count=0;
  var imgData=ctx.getImageData(0,0,canvas.width,canvas.height);
  for (var i=3;i<imgData.data.length;i+=4) {
    if(imgData.data[i]>0)count++;
  }
  return count/(imgData.data.length/4);
}

 var interval = setInterval(run,refresh_rate);
</script>
</body>
</html>
